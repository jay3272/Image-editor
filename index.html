<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”è¡“åœˆé¸å»èƒŒå·¥å…·</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: rgba(102, 126, 234, 0.05);
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(102, 126, 234, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
        }

        label {
            font-weight: bold;
            color: #333;
        }

        input[type="range"] {
            width: 100px;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .add-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .subtract-btn {
            background: linear-gradient(45deg, #f44336, #da190b);
        }

        .complete-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            font-weight: bold;
            padding: 12px 25px;
        }

        .canvas-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .canvas-wrapper {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: relative;
        }

        .canvas-wrapper:hover {
            transform: translateY(-3px);
        }

        canvas {
            border: 2px solid #ddd;
            border-radius: 10px;
            max-width: 450px;
            max-height: 450px;
            cursor: crosshair;
        }

        .canvas-title {
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .mode-select {
            background: #4CAF50;
        }

        .mode-add {
            background: #2196F3;
        }

        .mode-subtract {
            background: #f44336;
        }

        .instructions {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #333;
            line-height: 1.6;
        }

        .download-area {
            text-align: center;
            margin-top: 20px;
        }

        .download-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            font-size: 16px;
            padding: 12px 30px;
        }

        .value-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .selection-tools {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ é­”è¡“åœˆé¸å»èƒŒå·¥å…·</h1>
        
        <div class="upload-area" id="uploadArea">
            <p>å°‡åœ–ç‰‡æ‹–æ”¾åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡åœ–ç‰‡</p>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é¸æ“‡åœ–ç‰‡</button>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <div class="instructions">
            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong><br>
            1. é¸æ“‡æˆ–æ‹–æ”¾åœ–ç‰‡åˆ°ä¸Šæ–¹å€åŸŸ<br>
            2. èª¿æ•´å®¹å¿åº¦ï¼Œç„¶å¾Œåœ¨å·¦å´åŸåœ–ä¸Šé»æ“Š<strong>è¦ä¿ç•™çš„ç‰©é«”</strong><br>
            3. é¸å–å¾Œæœƒå‡ºç¾è™›ç·šæ¡†ï¼Œå¯ä½¿ç”¨ã€Œå¢åŠ ç¯„åœã€æˆ–ã€Œæ¸›å°‘ç¯„åœã€èª¿æ•´<br>
            4. æ»¿æ„é¸å–ç¯„åœå¾Œï¼Œé»æ“Šã€Œå®Œæˆå»èƒŒã€æŒ‰éˆ•ï¼ˆèƒŒæ™¯æœƒè¢«ç§»é™¤ï¼‰<br>
            5. å¯é‡è¤‡é¸å–å¤šå€‹è¦ä¿ç•™çš„å€åŸŸï¼Œæœ€å¾Œä¸‹è¼‰çµæœ
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="tolerance">å®¹å¿åº¦ï¼š</label>
                <input type="range" id="tolerance" min="1" max="100" value="30">
                <span class="value-display" id="toleranceValue">30</span>
            </div>
            <button id="resetBtn" disabled>é‡ç½®</button>
            <button id="undoBtn" disabled>å¾©åŸ</button>
        </div>

        <div class="selection-tools">
            <div class="tool-group">
                <button id="addRangeBtn" class="add-btn" disabled>â• å¢åŠ ç¯„åœ</button>
                <button id="subtractRangeBtn" class="subtract-btn" disabled>â– æ¸›å°‘ç¯„åœ</button>
            </div>
            <div class="tool-group">
                <button id="completeBtn" class="complete-btn" disabled>âœ… å®Œæˆå»èƒŒ</button>
                <button id="cancelSelectionBtn" disabled>âŒ å–æ¶ˆé¸å–</button>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-wrapper">
                <div class="canvas-title">åŸåœ–ï¼ˆé»æ“Šè¦ä¿ç•™çš„ç‰©é«”ï¼‰</div>
                <div class="mode-indicator mode-select" id="modeIndicator">é»æ“Šé¸å–</div>
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="canvas-wrapper">
                <div class="canvas-title">å»èƒŒçµæœ</div>
                <canvas id="resultCanvas"></canvas>
            </div>
        </div>

        <div class="download-area">
            <button class="download-btn" id="downloadBtn" disabled>ä¸‹è¼‰å»èƒŒåœ–ç‰‡</button>
        </div>
    </div>

    <script>
        class MagicSelectTool {
            constructor() {
                this.originalCanvas = document.getElementById('originalCanvas');
                this.resultCanvas = document.getElementById('resultCanvas');
                this.originalCtx = this.originalCanvas.getContext('2d');
                this.resultCtx = this.resultCanvas.getContext('2d');
                
                this.originalImageData = null;
                this.currentImageData = null;
                this.selectedPixels = new Set();
                this.tolerance = 30;
                this.history = [];
                
                this.mode = 'select'; // 'select', 'add', 'subtract'
                this.animationId = null;
                this.dashOffset = 0;
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');
                const toleranceSlider = document.getElementById('tolerance');
                const toleranceValue = document.getElementById('toleranceValue');
                const resetBtn = document.getElementById('resetBtn');
                const undoBtn = document.getElementById('undoBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                const addRangeBtn = document.getElementById('addRangeBtn');
                const subtractRangeBtn = document.getElementById('subtractRangeBtn');
                const completeBtn = document.getElementById('completeBtn');
                const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');

                // æ–‡ä»¶ä¸Šå‚³
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                
                // æ‹–æ”¾åŠŸèƒ½
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.loadImage(files[0]);
                    }
                });

                // å®¹å¿åº¦èª¿æ•´
                toleranceSlider.addEventListener('input', (e) => {
                    this.tolerance = parseInt(e.target.value);
                    toleranceValue.textContent = this.tolerance;
                });

                // ç•«å¸ƒé»æ“Š
                this.originalCanvas.addEventListener('click', (e) => this.handleCanvasClick(e));

                // æŒ‰éˆ•åŠŸèƒ½
                resetBtn.addEventListener('click', () => this.resetImage());
                undoBtn.addEventListener('click', () => this.undoLastAction());
                downloadBtn.addEventListener('click', () => this.downloadResult());
                addRangeBtn.addEventListener('click', () => this.setMode('add'));
                subtractRangeBtn.addEventListener('click', () => this.setMode('subtract'));
                completeBtn.addEventListener('click', () => this.completeSelection());
                cancelSelectionBtn.addEventListener('click', () => this.cancelSelection());
            }

            setMode(mode) {
                this.mode = mode;
                const modeIndicator = document.getElementById('modeIndicator');
                const originalCanvas = this.originalCanvas;
                
                switch(mode) {
                    case 'select':
                        modeIndicator.textContent = 'é¸å–ç‰©é«”';
                        modeIndicator.className = 'mode-indicator mode-select';
                        originalCanvas.style.cursor = 'crosshair';
                        break;
                    case 'add':
                        modeIndicator.textContent = 'å¢åŠ ç‰©é«”';
                        modeIndicator.className = 'mode-indicator mode-add';
                        originalCanvas.style.cursor = 'copy';
                        break;
                    case 'subtract':
                        modeIndicator.textContent = 'æ¸›å°‘ç¯„åœ';
                        modeIndicator.className = 'mode-indicator mode-subtract';
                        originalCanvas.style.cursor = 'not-allowed';
                        break;
                }
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.loadImage(file);
                }
            }

            loadImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.setupCanvases(img);
                        this.drawOriginalImage(img);
                        this.resetImage();
                        this.updateButtons();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            setupCanvases(img) {
                const maxSize = 450;
                let { width, height } = img;
                
                if (width > maxSize || height > maxSize) {
                    const ratio = Math.min(maxSize / width, maxSize / height);
                    width *= ratio;
                    height *= ratio;
                }

                this.originalCanvas.width = width;
                this.originalCanvas.height = height;
                this.resultCanvas.width = width;
                this.resultCanvas.height = height;
            }

            drawOriginalImage(img) {
                this.originalCtx.drawImage(img, 0, 0, this.originalCanvas.width, this.originalCanvas.height);
                this.originalImageData = this.originalCtx.getImageData(0, 0, this.originalCanvas.width, this.originalCanvas.height);
                this.currentImageData = new ImageData(
                    new Uint8ClampedArray(this.originalImageData.data),
                    this.originalImageData.width,
                    this.originalImageData.height
                );
            }

            handleCanvasClick(event) {
                if (!this.originalImageData) return;

                const rect = this.originalCanvas.getBoundingClientRect();
                const scaleX = this.originalCanvas.width / rect.width;
                const scaleY = this.originalCanvas.height / rect.height;
                
                const x = Math.floor((event.clientX - rect.left) * scaleX);
                const y = Math.floor((event.clientY - rect.top) * scaleY);

                if (this.mode === 'select') {
                    this.selectedPixels.clear();
                    this.magicSelect(x, y);
                    this.startDashAnimation();
                } else if (this.mode === 'add') {
                    this.magicSelect(x, y, true);
                } else if (this.mode === 'subtract') {
                    this.magicSelect(x, y, false, true);
                }
                
                this.drawSelectionOverlay();
                this.updateButtons();
            }

            magicSelect(startX, startY, addToSelection = false, subtractFromSelection = false) {
                const imageData = this.originalImageData;
                const data = imageData.data;
                const width = imageData.width;
                const height = imageData.height;

                // ç²å–èµ·å§‹é»é¡è‰²
                const startIndex = (startY * width + startX) * 4;
                const targetColor = {
                    r: data[startIndex],
                    g: data[startIndex + 1],
                    b: data[startIndex + 2]
                };

                // å·²è¨ªå•çš„åƒç´ æ¨™è¨˜
                const visited = new Array(width * height).fill(false);
                const stack = [{x: startX, y: startY}];
                const newSelection = new Set();

                while (stack.length > 0) {
                    const {x, y} = stack.pop();
                    
                    if (x < 0 || x >= width || y < 0 || y >= height) continue;
                    
                    const index = y * width + x;
                    if (visited[index]) continue;
                    
                    const pixelIndex = index * 4;
                    const currentColor = {
                        r: data[pixelIndex],
                        g: data[pixelIndex + 1],
                        b: data[pixelIndex + 2]
                    };

                    // æª¢æŸ¥é¡è‰²ç›¸ä¼¼åº¦
                    if (this.colorDistance(targetColor, currentColor) <= this.tolerance) {
                        visited[index] = true;
                        newSelection.add(index);
                        
                        // æ·»åŠ ç›¸é„°åƒç´ åˆ°å †ç–Š
                        stack.push({x: x + 1, y: y});
                        stack.push({x: x - 1, y: y});
                        stack.push({x: x, y: y + 1});
                        stack.push({x: x, y: y - 1});
                    }
                }

                // æ ¹æ“šæ¨¡å¼æ›´æ–°é¸å–ç¯„åœ
                if (subtractFromSelection) {
                    newSelection.forEach(index => this.selectedPixels.delete(index));
                } else {
                    newSelection.forEach(index => this.selectedPixels.add(index));
                }
            }

            colorDistance(color1, color2) {
                return Math.sqrt(
                    Math.pow(color1.r - color2.r, 2) +
                    Math.pow(color1.g - color2.g, 2) +
                    Math.pow(color1.b - color2.b, 2)
                );
            }

            drawSelectionOverlay() {
                // é‡ç¹ªåŸåœ–
                this.originalCtx.putImageData(this.originalImageData, 0, 0);
                
                if (this.selectedPixels.size === 0) return;

                // æ‰¾å‡ºé¸å–å€åŸŸçš„é‚Šç•Œ
                const bounds = this.getSelectionBounds();
                if (!bounds) return;

                // ç¹ªè£½è™›ç·šé‚Šæ¡†
                this.originalCtx.strokeStyle = '#ff0000';
                this.originalCtx.lineWidth = 2;
                this.originalCtx.setLineDash([8, 4]);
                this.originalCtx.lineDashOffset = this.dashOffset;
                
                // ç¹ªè£½é¸å–å€åŸŸçš„è¼ªå»“
                this.drawSelectionOutline();
            }

            getSelectionBounds() {
                if (this.selectedPixels.size === 0) return null;
                
                const width = this.originalImageData.width;
                let minX = width, minY = this.originalImageData.height;
                let maxX = 0, maxY = 0;
                
                this.selectedPixels.forEach(index => {
                    const x = index % width;
                    const y = Math.floor(index / width);
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minY = Math.min(minY, y);
                    maxY = Math.max(maxY, y);
                });
                
                return { minX, minY, maxX, maxY };
            }

            drawSelectionOutline() {
                const width = this.originalImageData.width;
                const height = this.originalImageData.height;
                const processed = new Set();
                
                this.originalCtx.beginPath();
                
                this.selectedPixels.forEach(index => {
                    const x = index % width;
                    const y = Math.floor(index / width);
                    
                    // æª¢æŸ¥å››å€‹é‚Šæ˜¯å¦éœ€è¦ç¹ªè£½é‚Šç•Œ
                    const left = x === 0 || !this.selectedPixels.has(index - 1);
                    const right = x === width - 1 || !this.selectedPixels.has(index + 1);
                    const top = y === 0 || !this.selectedPixels.has(index - width);
                    const bottom = y === height - 1 || !this.selectedPixels.has(index + width);
                    
                    if (left) {
                        this.originalCtx.moveTo(x, y);
                        this.originalCtx.lineTo(x, y + 1);
                    }
                    if (right) {
                        this.originalCtx.moveTo(x + 1, y);
                        this.originalCtx.lineTo(x + 1, y + 1);
                    }
                    if (top) {
                        this.originalCtx.moveTo(x, y);
                        this.originalCtx.lineTo(x + 1, y);
                    }
                    if (bottom) {
                        this.originalCtx.moveTo(x, y + 1);
                        this.originalCtx.lineTo(x + 1, y + 1);
                    }
                });
                
                this.originalCtx.stroke();
            }

            startDashAnimation() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
                
                const animate = () => {
                    this.dashOffset -= 0.5;
                    this.drawSelectionOverlay();
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            completeSelection() {
                if (this.selectedPixels.size === 0) return;
                
                this.saveToHistory();
                
                // åå‘é‚è¼¯ï¼šç§»é™¤æœªé¸å–çš„åƒç´ ï¼ˆä¿ç•™é¸å–çš„åƒç´ ï¼‰
                const data = this.currentImageData.data;
                const width = this.currentImageData.width;
                const height = this.currentImageData.height;
                
                for (let i = 0; i < width * height; i++) {
                    if (!this.selectedPixels.has(i)) {
                        const pixelIndex = i * 4;
                        data[pixelIndex + 3] = 0; // è¨­ç‚ºé€æ˜ï¼ˆå»é™¤èƒŒæ™¯ï¼‰
                    }
                }
                
                // æ¸…é™¤é¸å–å’Œåœæ­¢å‹•ç•«
                this.selectedPixels.clear();
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                
                // é‡ç¹ªåŸåœ–å’Œçµæœ
                this.originalCtx.putImageData(this.originalImageData, 0, 0);
                this.updateResult();
                this.setMode('select');
                this.updateButtons();
            }

            cancelSelection() {
                this.selectedPixels.clear();
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                this.originalCtx.putImageData(this.originalImageData, 0, 0);
                this.setMode('select');
                this.updateButtons();
            }

            updateResult() {
                this.resultCtx.clearRect(0, 0, this.resultCanvas.width, this.resultCanvas.height);
                
                // ç¹ªè£½æ£‹ç›¤æ ¼èƒŒæ™¯
                this.drawCheckerboard();
                
                // ç¹ªè£½å»èƒŒåœ–ç‰‡
                this.resultCtx.putImageData(this.currentImageData, 0, 0);
            }

            drawCheckerboard() {
                const size = 10;
                for (let y = 0; y < this.resultCanvas.height; y += size) {
                    for (let x = 0; x < this.resultCanvas.width; x += size) {
                        const isEven = (Math.floor(x / size) + Math.floor(y / size)) % 2 === 0;
                        this.resultCtx.fillStyle = isEven ? '#f0f0f0' : '#e0e0e0';
                        this.resultCtx.fillRect(x, y, size, size);
                    }
                }
            }

            saveToHistory() {
                this.history.push(new ImageData(
                    new Uint8ClampedArray(this.currentImageData.data),
                    this.currentImageData.width,
                    this.currentImageData.height
                ));
                
                // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
                if (this.history.length > 10) {
                    this.history.shift();
                }
            }

            resetImage() {
                if (this.originalImageData) {
                    this.currentImageData = new ImageData(
                        new Uint8ClampedArray(this.originalImageData.data),
                        this.originalImageData.width,
                        this.originalImageData.height
                    );
                    this.selectedPixels.clear();
                    if (this.animationId) {
                        cancelAnimationFrame(this.animationId);
                        this.animationId = null;
                    }
                    this.originalCtx.putImageData(this.originalImageData, 0, 0);
                    this.updateResult();
                    this.setMode('select');
                    this.history = [];
                }
            }

            undoLastAction() {
                if (this.history.length > 0) {
                    this.currentImageData = this.history.pop();
                    this.updateResult();
                    this.updateButtons();
                }
            }

            updateButtons() {
                const hasImage = this.originalImageData !== null;
                const hasHistory = this.history.length > 0;
                const hasSelection = this.selectedPixels.size > 0;
                
                document.getElementById('resetBtn').disabled = !hasImage;
                document.getElementById('undoBtn').disabled = !hasHistory;
                document.getElementById('downloadBtn').disabled = !hasImage;
                document.getElementById('addRangeBtn').disabled = !hasSelection;
                document.getElementById('subtractRangeBtn').disabled = !hasSelection;
                document.getElementById('completeBtn').disabled = !hasSelection;
                document.getElementById('cancelSelectionBtn').disabled = !hasSelection;
            }

            downloadResult() {
                if (!this.currentImageData) return;
                
                const link = document.createElement('a');
                link.download = 'magic-select-result.png';
                link.href = this.resultCanvas.toDataURL();
                link.click();
            }
        }

        // åˆå§‹åŒ–å·¥å…·
        new MagicSelectTool();
    </script>
</body>
</html>